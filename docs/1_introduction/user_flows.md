# ユーザーフロー設計書

## 概要
Care Packageアプリケーションの3つのユーザータイプのフローと画面遷移を定義します。

## ユーザータイプ
1. **運営者（管理者）**: システム全体の管理
2. **店舗経営者**: 自店舗の管理・運営
3. **一般顧客**: 店舗情報の閲覧

---

## 1. 全体システム構成図

```mermaid
graph TB
    subgraph "Care Package System"
        subgraph "Frontend Applications"
            A[運営管理サイト<br/>packages/admin<br/>React SPA]
            B[店舗経営者管理サイト<br/>packages/store-admin<br/>React SPA]
            C[店舗サイト<br/>packages/store-site<br/>Next.js SSR]
        end
        
        subgraph "Backend Services"
            D[Backend API<br/>packages/api<br/>Hono + PostgreSQL]
        end
        
        subgraph "External Services"
            E[Google OAuth 2.0]
            F[Google Maps API]
            G[Google My Business API]
            H[PAY.JP API]
        end
    end
    
    A --> D
    B --> D
    C --> D
    B --> E
    D --> F
    D --> G
    D --> H
```

---

## 2. 運営者フロー

### 2.1 認証フロー
```mermaid
flowchart TD
    A[ログインページアクセス] --> B[ID/PW入力]
    B --> C{認証確認}
    C -->|成功| D[ダッシュボードへリダイレクト]
    C -->|失敗| E[エラーメッセージ表示]
    E --> B
    D --> F[JWT토큰でセッション管理]
```

### 2.2 主要業務フロー
```mermaid
flowchart TD
    A[ダッシュボード] --> B[顧客管理]
    A --> C[店舗管理] 
    A --> D[課金管理]
    A --> E[システム設定]
    
    B --> B1[契約済み顧客一覧]
    B --> B2[新規顧客情報登録]
    B --> B3[認証リンク発行・送信]
    B --> B4[顧客状態変更]
    
    C --> C1[店舗一覧]
    C --> C2[店舗詳細情報]
    C --> C3[店舗サイト確認]
    
    D --> D1[料金プラン管理]
    D --> D2[決済状況確認]
    D --> D3[売上レポート]
    
    subgraph "顧客招待フロー"
        B2 --> F[契約済み情報入力]
        F --> F1[顧客基本情報]
        F --> F2[店舗基本情報]
        F --> F3[契約・プラン情報]
        F1 --> G[認証リンク生成]
        F2 --> G
        F3 --> G
        G --> H[招待メール送信]
        H --> I[招待状況追跡]
    end
```

---

## 3. 店舗経営者フロー

### 3.1 初回登録フロー（運営承認制）
```mermaid
flowchart TD
    A[店舗経営者] --> B[運営への問い合わせ]
    B --> C[営業・商談]
    C --> D[契約締結]
    D --> E[運営：顧客情報をシステム登録]
    E --> F[運営：認証リンク発行]
    F --> G[認証リンクをメール送信]
    
    G --> H[顧客：メール受信]
    H --> I[認証リンククリック]
    I --> J[Google OAuth認証]
    J --> K{認証成功？}
    K -->|失敗| L[エラーページ]
    K -->|成功| M[利用規約同意]
    M --> N[事前入力情報確認]
    N --> O[不足情報の補完入力]
    O --> P[店舗詳細情報入力]
    P --> Q[営業時間・サービス設定]
    Q --> R[決済情報入力]
    R --> S[登録完了・確認]
    S --> T[店舗サイト自動生成]
    T --> U[管理ダッシュボード]
```

### 3.2 日常運用フロー
```mermaid
flowchart TD
    A[ログイン] --> B[ダッシュボード]
    B --> C[店舗情報管理]
    B --> D[お知らせ投稿]
    B --> E[口コミ管理]
    B --> F[MEO対策]
    B --> G[プラン管理]
    
    C --> C1[基本情報更新]
    C --> C2[営業時間変更]
    C --> C3[メニュー管理]
    C --> C4[写真管理]
    
    D --> D1[お知らせ作成]
    D --> D2[公開設定]
    D --> D3[店舗サイトに反映]
    
    E --> E1[Google口コミ確認]
    E --> E2[返信管理]
    
    F --> F1[Googleマイビジネス連携]
    F --> F2[マップ情報更新]
    
    G --> G1[現在プラン確認]
    G --> G2[プラン変更]
    G --> G3[支払い履歴]
```

---

## 4. 一般顧客フロー

### 4.1 店舗発見・閲覧フロー
```mermaid
flowchart TD
    A[検索エンジン] --> D[店舗サイト]
    B[Googleマップ] --> D
    C[SNSリンク] --> D
    
    D --> E[店舗トップページ]
    E --> F[基本情報確認]
    E --> G[営業時間確認]
    E --> H[アクセス情報]
    E --> I[最新お知らせ]
    E --> J[メニュー・サービス]
    
    F --> K[電話をかける]
    H --> L[地図アプリで経路確認]
    I --> M[詳細ページ]
    J --> N[SNSシェア]
    
    subgraph "顧客行動"
        K
        L
        N
        O[店舗訪問]
    end
```

---

## 5. データフロー図

```mermaid
flowchart TB
    subgraph "Data Flow"
        A[運営者] -->|契約情報・店舗基本情報入力| B[Backend API]
        A -->|招待リンク発行| B
        
        B -->|招待データ保存| C[(PostgreSQL)]
        B -->|招待メール送信| D[Email Service]
        
        E[店舗経営者] -->|招待リンクから認証| B
        E -->|事前情報確認・詳細入力| B
        E -->|店舗情報更新| B
        E -->|お知らせ投稿| B
        
        B -->|店舗データ保存| C
        B -->|Google連携| F[Google My Business API]
        B -->|マップ更新| G[Google Maps API]
        
        C -->|店舗データ| H[店舗サイト自動生成]
        H -->|SEO最適化| I[静的サイト]
        
        J[一般顧客] -->|サイト閲覧| I
        
        K[決済処理] -->|課金情報| B
        B -->|プラン管理| K
    end
```

---

## 6. 認証・認可設計

### 6.1 認証方式
| ユーザータイプ | 認証方式 | 実装状況 |
|--------------|----------|----------|
| 運営者 | ID/PW + JWT | ✅ 実装済み |
| 店舗経営者 | Google OAuth + JWT | ❌ 未実装 |
| 一般顧客 | 認証不要 | - |

### 6.2 権限設計
```mermaid
graph TD
    A[Super Admin] --> B[Admin権限]
    B --> C[全ユーザー管理]
    B --> D[全店舗管理]
    B --> E[システム設定]
    B --> F[課金管理]
    
    G[Store Owner] --> H[Store権限] 
    H --> I[自店舗管理のみ]
    H --> J[自店舗お知らせ]
    H --> K[自プラン管理]
    
    L[Customer] --> M[閲覧権限]
    M --> N[店舗サイト閲覧のみ]
```

---

## 7. 今後の開発優先順位

### Phase 3: 店舗経営者管理サイト基盤
1. **Google OAuth認証実装**
2. **店舗経営者管理サイト構築** (`packages/store-admin`)
3. **店舗情報管理機能**
4. **基本的なダッシュボード**

### Phase 4: 店舗サイト自動生成
1. **店舗サイト構築** (`packages/store-site`)
2. **Next.js SSR実装**
3. **SEO最適化**
4. **店舗データとの連携**

### Phase 5: 決済・課金システム
1. **PAY.JP連携**
2. **プラン管理**
3. **決済フロー**
4. **課金管理機能**

### Phase 6: 高度な機能
1. **Google Maps API連携**
2. **Google My Business連携**
3. **口コミ管理**
4. **MEO対策機能**

---

## 8. 画面一覧

### 8.1 運営管理サイト (admin)
- [x] ログインページ
- [x] ダッシュボード
- [x] ユーザー管理（モック）
- [x] 店舗管理（モック）
- [ ] **顧客管理・招待機能**
  - [ ] 契約済み顧客一覧
  - [ ] 新規顧客招待登録
    - [ ] 顧客基本情報入力（名前、メール、電話）
    - [ ] 店舗基本情報入力（店名、住所、電話、カテゴリ）
    - [ ] 契約情報入力（プラン、開始日、料金）
    - [ ] 招待リンク生成・送信
  - [ ] 招待状況追跡・管理
- [ ] 課金管理
- [ ] システム設定
- [ ] レポート・分析

### 8.2 店舗経営者管理サイト (store-admin) - 未作成
- [ ] **招待専用認証フロー**
  - [ ] 招待リンク検証ページ
  - [ ] Google OAuth認証
  - [ ] 利用規約同意ページ
  - [ ] 事前入力情報確認画面
  - [ ] 不足情報補完入力画面
  - [ ] 店舗詳細情報入力画面（営業時間、サービス詳細等）
- [ ] ダッシュボード
- [ ] 店舗情報管理
- [ ] お知らせ投稿
- [ ] 口コミ管理
- [ ] MEO設定
- [ ] プラン管理

### 8.3 店舗サイト (store-site) - 未作成
- [ ] 店舗トップページ
- [ ] 店舗詳細情報
- [ ] お知らせ一覧
- [ ] アクセス・地図
- [ ] メニュー・サービス
- [ ] お問い合わせ

---

このユーザーフロー設計に基づいて、今後の開発を進めていきます。