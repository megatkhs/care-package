---
tags:
  - バックログ
  - Phase3
  - 店舗経営者管理サイト
  - Google OAuth
type: 作業計画
status: 検討中
created: 2025-01-24
updated: 2025-07-24
---

# Phase 3: 店舗経営者管理サイト基盤 - 作業計画

> [!info] Phase 3 概要
> 店舗経営者向け管理サイト `packages/store-admin` の基盤構築を行う。Google OAuth認証システムと基本的な店舗管理機能を実装する。

## 🎯 目標
- Google OAuth 2.0による認証システムの実装
- 店舗経営者向け管理画面の基盤構築
- 招待システムの実装（運営側からの招待→Google OAuthでの登録）
- 基本的な店舗情報管理機能

## 📋 タスク一覧

> [!note] 認証戦略
> フロントエンドは `@react-oauth/google` を利用してGoogleからIDトークンを取得。バックエンドのHono APIはIDトークンを検証し、システム独自のJWTを発行してセッション管理を行う。この方式は `tech_stack.md` の規定に準拠する。

### 1. プロジェクト基盤設定 🏗️
- [ ] **1-1. store-adminパッケージの初期セットアップ**
  - Vite + React + TypeScript + Tailwind CSS環境構築 (`admin`パッケージ構成および`tech_stack.md`を踏襲)
  - 基本的なフォルダ構造作成
  - 共通コンポーネントの設定
  
- [ ] **1-2. 開発環境設定**
  - Docker Compose設定更新（新パッケージ対応）
  - pnpm workspace設定更新
  - Biome設定

### 2. 認証システム実装 🔐
- [ ] **2-1. Google OAuth 2.0設定**
  - Google Cloud ConsoleでOAuthクライアントID設定
  - 環境変数設定 (`.env.example` への追加)
  
- [ ] **2-2. 認証API実装（バックエンド）**
  - `/api/auth/google/callback` エンドポイント作成
  - Google IDトークン検証ロジック実装
  - `invitations`テーブルと連携し、招待されたメールアドレスか確認
  - `users`テーブルへのユーザー情報UPSERT処理
  - Hono独自のJWT発行処理 (`hono/jwt`ミドルウェアを活用)
  - `/api/auth/me` エンドポイント（店舗経営者情報取得）
  
- [ ] **2-3. 認証フロー実装（フロントエンド）**
  - `@react-oauth/google` の導入と設定
  - ログイン画面作成とGoogleログインボタン設置
  - 認証状態を管理するContext (または Zustand/Jotai) の実装
  - 認証が必要なルートを守るための `ProtectedRoute` コンポーネント実装

### 3. 招待システム実装 📮
- [ ] **3-1. 招待機能設計**
  - 招待テーブル設計確認
  - 招待フロー設計
  - 招待コード生成ロジック
  
- [ ] **3-2. 運営側招待機能**
  - `packages/admin` に招待発行UI追加
  - 招待トークン生成・管理機能
  - 招待状況管理画面
  - 招待メール送信機能（将来実装）
  
- [ ] **3-3. 店舗経営者側登録フロー**
  - 招待コード確認機能
  - Google OAuth + 招待コード連携
  - 初回登録フロー

### 4. 基本管理画面実装 🎨
- [ ] **4-1. レイアウト・デザインシステム**
  - 基本レイアウト作成 (Header, Sidebar, Content)
  - ナビゲーション実装
  - レスポンシブ対応
  
- [ ] **4-2. ダッシュボード画面**
  - メイン画面作成
  - 店舗情報サマリー表示
  - 基本統計情報表示
  
- [ ] **4-3. 店舗情報管理画面**
  - 店舗基本情報編集画面
  - 営業時間設定画面
  - 画像アップロード機能（基本）

### 5. API連携実装 🔗
- [ ] **5-1. 店舗情報管理API**
  - 店舗情報取得API
  - 店舗情報更新API
  - バリデーション実装
  
- [ ] **5-2. 認証付きAPI実装**
  - JWT認証ミドルウェア
  - 店舗経営者権限チェック
  - エラーハンドリング

### 6. テスト・品質管理 ✅
- [ ] **6-1. 単体テスト実装**
  - 認証ロジックのテスト
  - API エンドポイントのテスト
  - フロントエンドコンポーネントテスト
  
- [ ] **6-2. 統合テスト**
  - 認証フローのE2Eテスト
  - 店舗情報管理フローのテスト
  
- [ ] **6-3. 品質チェック**
  - 静的解析（Biome）
  - 型チェック
  - セキュリティチェック

## 🗄️ データベース設計確認

既存のテーブル構成：
- `customers`: 契約者マスタデータ ✅
- `contracts`: 契約管理 ✅
- `invitations`: 招待プロセス管理 ✅
- `stores`: 店舗情報 ✅
- `users`: Google OAuth認証ユーザー ✅
- `admins`: 運営管理者 ✅

## 🔧 技術スタック

> [!tip] `tech_stack.md` に基づく構成

### フロントエンド
- **フレームワーク**: Vite + React
- **認証**: `@react-oauth/google`
- **スタイリング**: Tailwind CSS
- **状態管理**: React Context / Jotai / Zustand (必要に応じて導入)
- **HTTP クライアント**: axios
- **ルーティング**: `react-router-dom`

### バックエンド
- **フレームワーク**: Hono（既存）
- **認証**: JWT + Google ID Token
- **データベース**: PostgreSQL + Drizzle ORM（既存）

## 🎯 成功基準

### 必須要件
- [ ] Google OAuth でログイン/ログアウトができる
- [ ] 運営側から店舗経営者を招待できる
- [ ] 招待されたユーザーがGoogle OAuthで登録できる
- [ ] 店舗経営者が自分の店舗情報を閲覧・編集できる
- [ ] 認証が必要な画面で適切にガードされている

### 品質要件
- [ ] すべての画面がスマートフォンで操作可能
- [ ] 認証情報が適切にセキュアに管理されている
- [ ] 静的解析・型チェックが通る
- [ ] 基本的なテストが実装されている

## ⚠️ リスク・懸念事項

### 技術的リスク
- **Google OAuth設定の複雑さ**: Google Cloud Console設定は依然として注意が必要。
- **フロントエンドとバックエンドの連携**: IDトークンの受け渡しとJWTのライフサイクル管理。

### セキュリティリスク
- **OAuth認証フローのセキュリティ**: IDトークン検証をバックエンドで厳密に行う必要がある。
- **JWTトークンの適切な管理**: フロントエンドでの安全な保管（HttpOnly Cookie推奨）。
- **店舗データのアクセス制御**: 既存 `authMiddleware` の拡張・適用。

### UX/UIリスク
- **スマートフォンでの操作性**: レスポンシブデザインの品質。
- **初回登録フローの分かりやすさ**: 招待→OAuth→登録のフローをシンプルに伝えるUI。
- **エラーハンドリング**: 認証失敗やAPIエラー時の分かりやすいフィードバック。

### 実装上の注意点
- **環境変数管理**: ViteとHonoでの環境変数の取り扱い。
- **既存authMiddlewareの活用**: `userType: 'user'` での権限分離実装。

## 📅 想定スケジュール

| フェーズ | 想定工数 | 備考 |
|---------|---------|------|
| 1. プロジェクト基盤設定 | 0.5日 | 環境構築 |
| 2. 認証システム実装 | 2日 | Google OAuth + Hono連携 |
| 3. 招待システム実装 | 1.5日 | 運営側＋店舗側 |
| 4. 基本管理画面実装 | 2日 | UI/UX実装 |
| 5. API連携実装 | 1日 | バックエンド連携 |
| 6. テスト・品質管理 | 1.5日 | テスト・品質チェック |
| **合計** | **8.5日** | 1.5-2週間程度 |

## 🔗 関連ドキュメント
- [[docs/1_introduction/development_phases.md]]
- [[docs/2_architecture/database.md]]
- [[docs/1_introduction/tech_stack.md]]
