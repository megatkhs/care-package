# ADR-0002: モノリポジトリ管理にTurborepoを採用

## ステータス
承認済み（実装済み）

## コンテキスト
ケアパッケージプロジェクトでは、以下の複数のアプリケーションを同一リポジトリで管理する必要がある：

- `packages/api`: Honoバックエンド
- `packages/admin`: 運営管理サイト（React SPA）
- `packages/store-admin`: 店舗管理サイト（React SPA）
- `packages/store-site`: 店舗サイト（Next.js）
- `packages/shared`: 共通ライブラリ・型定義

これらのパッケージ間で型定義を共有し、効率的なビルド・開発環境を構築する必要がある。また、個人開発プロジェクトのため、シンプルで保守しやすいツールチェーンが求められる。

## 決定内容
モノリポジトリ管理ツールとして **Turborepo** を採用し、パッケージマネージャーには **pnpm** を使用する。

### 具体的な構成
```json
// turbo.json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "check": {},
    "format": {}
  }
}
```

## 根拠

### 検討した選択肢

#### 選択肢A: Turborepo + pnpm（採用）
**メリット:**
- 高速な並列ビルド・キャッシュ機能
- pnpmとの相性が良い
- 設定がシンプル
- Vercelが開発・メンテナンス（継続性が高い）
- TypeScriptサポートが充実

**デメリット:**
- 比較的新しいツール
- 学習コスト

#### 選択肢B: Lerna + pnpm
**メリット:**
- 成熟したツール、豊富な実績
- 詳細な設定が可能

**デメリット:**
- 設定が複雑
- ビルドキャッシュ機能が弱い
- 開発が停滞気味

#### 選択肢C: pnpm workspace のみ
**メリット:**
- 最もシンプル
- 学習コストが低い

**デメリット:**
- 並列ビルド・キャッシュ機能なし
- タスク管理機能が弱い
- スケールしにくい

### 決定要因
1. **パフォーマンス**: 並列ビルド・キャッシュによる開発効率向上
2. **シンプリシティ**: 設定がシンプルで保守しやすい
3. **TypeScript統合**: 型チェック・共有型定義の管理が容易
4. **将来性**: Vercelによる積極的な開発・コミュニティサポート
5. **pnpm連携**: pnpm workspaceとの親和性

## 結果

### ポジティブな影響
- **開発効率向上**: 並列実行により`pnpm dev`で全パッケージを同時起動
- **ビルド高速化**: キャッシュ機能により再ビルド時間を大幅短縮
- **型安全性**: 共通型定義の変更が全パッケージに即座に反映
- **CI/CD最適化**: GitHub Actionsでの並列テスト・ビルドが可能

### ネガティブな影響・リスク
- **学習コスト**: 新規参画者がTurborepのコンセプトを理解する必要
  - **対策**: `docs/3_guides/getting_started.md`に詳細な手順を記載
- **設定の複雑化**: プロジェクト規模拡大時の設定調整
  - **対策**: 段階的にpipelineを最適化、ドキュメント化

### パフォーマンスへの影響
- **初回ビルド**: 従来と同等（約2-3分）
- **再ビルド**: キャッシュにより30-50%高速化
- **開発サーバー起動**: 全パッケージ同時起動（約10-15秒）

## 実装上の注意点

### パッケージ依存関係
```json
// 依存関係の正しい定義が重要
{
  "dependencies": {
    "@care-package/shared": "workspace:*"
  }
}
```

### タスク依存関係
- `build`タスクは依存パッケージのビルド完了後に実行
- `dev`タスクはキャッシュ無効、persistent モード
- `lint`, `check`, `format`は独立実行可能

### 推奨コマンド
```bash
# 全パッケージ実行
pnpm dev
pnpm build
pnpm lint

# 特定パッケージのみ
pnpm --filter=@care-package/admin dev
pnpm --filter=@care-package/api build
```

## 関連する決定
- [ADR-0003: pnpmをパッケージマネージャーとして採用](./0003-adopt-pnpm-package-manager.md)
- [技術スタック詳細](../1_introduction/tech_stack.md)
- [システム構成](../2_architecture/system_overview.md)

## 履歴
- 2025-01-23: 初版作成、Phase 1で実装・検証済み
- 2025-01-23: Phase 2で運営管理サイト追加時に動作確認済み